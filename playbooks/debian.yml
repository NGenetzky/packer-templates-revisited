---
- name: debian | Update Apt Cache
  apt:
    update_cache: true
  become: true

- name: debian | Installing cloud-initramfs-growroot
  apt:
    name: cloud-initramfs-growroot
    state: present
  become: true
  when:
    - ansible_distribution != "Ubuntu"
    - ansible_distribution_version is version('20.04', '>=')

- name: debian | Uninstall qemu-guest-agent
  apt:
    name: qemu-guest-agent
    state: absent
  become: true
  when: packer_builder_type not in ["proxmox", "qemu"]

- name: debian | Configuring /etc/rc.local
  copy:
    content: |
      #!/bin/sh -e
      test -f /etc/ssh/ssh_host_dsa_key || dpkg-reconfigure openssh-server
      exit 0
    dest: /etc/rc.local
    mode: u=rwx,g=rx,o=rx
  become: true

# * VIRTUAL MACHINES
#
#     on virtual machines (according to the udev README) you will need to remove
#     the files /etc/systemd/network/99-default.link and (if using virtio network
#     devices) /etc/systemd/network/50-virtio-kernel-names.link, then rebuild the
#     initrd.
#
# * INITRD SKEW
#
#     it's all very well having everything sorted out in /etc, but interface
#     renaming has to happen very early during boot; to make sure your initrd
#     doesn't contain out-of-date versions of important systemd files, regenerate
#     it with sudo update-initramfs -u
- name: debian | Avoid issues with network interface name policies
  shell: |
    rm -f \
      /etc/systemd/network/50-virtio-kernel-names.link \
      /etc/systemd/network/99-default.link \
      /etc/udev/rules.d/70-persistent-net.rules \
      /lib/systemd/network/99-default.link \
      && \
    sudo update-initramfs -u
  become: true

- name: debian | Ensure eth0 is always dhcp
  lineinfile:
    line: "{{ item.line }}"
    path: "/etc/network/interfaces"
    state: present
  become: true
  loop:
    - line: "iface eth0 inet dhcp"
    - line: "allow-hotplug eth0"
